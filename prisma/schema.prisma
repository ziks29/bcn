
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  username  String   @unique
  phoneNumber String?
  displayName String?
  registrationNumber String?
  bio       String?
  password  String
  role      String   @default("AUTHOR")
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())
  articles  Article[]
  notifications Notification[]
  ordersAsEmployee   Order[]       @relation("OrderEmployee")
  ordersCreated      Order[]       @relation("OrderCreator")
  paymentsReceived   Payment[]     @relation("PaymentReceiver")
  employeePaymentsProcessed EmployeePayment[] @relation("EmployeePaymentProcessor")
  transactionsCreated Transaction[] @relation("TransactionCreator")
  notes          Note[]
  noteCategories NoteCategory[]
}

model Article {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  slug      String   @unique
  excerpt   String
  content   String
  image     String?
  category  String
  authorDisplay String @default("Редакция")
  status    String   @default("DRAFT")
  publishFrom DateTime?
  publishTo   DateTime?
  views     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  author    User     @relation(fields: [authorId], references: [id])
  authorId  String   @db.ObjectId
  
  isEditableByAll Boolean @default(false)
  
  // Indexes for query performance
  @@index([status])
  @@index([createdAt])
  @@index([authorId])
}

model Ad {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  company   String
  tagline   String
  imageUrl  String
  phone     String
  buttonText String?
  buttonUrl String?
  districts String?
  bw        Boolean  @default(true)
  status    String   @default("DRAFT")
  publishFrom DateTime?
  publishTo   DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GalleryItem {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  url       String
  name      String?
  type      String   @default("UPLOAD") // "UPLOAD" or "EXTERNAL"
  createdAt DateTime @default(now())
}

model Category {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
}

model Contact {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  phone     String   @unique
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  customer  String
  adText    String
  quantity  Int
  startDate String   // Stored as YYYY-MM-DD
  endDate   String   // Stored as YYYY-MM-DD
  startTime String
  endTime   String
  author    String

  sentCount    Int       @default(0)
  lastSentTime DateTime?

  history   NotificationHistory[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isArchived Boolean @default(false)
  employeeRate Float @default(42.5) // Default payout per send for employee
  
  authorId  String?  @db.ObjectId
  authorUser User?   @relation(fields: [authorId], references: [id])
  
  // Indexes for query performance
  @@index([isArchived])
  @@index([createdAt])
  @@index([authorId])
  
  // Link to Order
  orderId   String?  @db.ObjectId
  order     Order?   @relation(fields: [orderId], references: [id])
}

type NotificationHistory {
  userName  String
  userId    String?  @db.ObjectId
  timestamp DateTime
  isPaid    Boolean  @default(false)
  employeePaymentId String? @db.ObjectId
}

model ExcalidrawBoard {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  elements  Json
  appState  Json
  files     Json     @default("{}")
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model ExcalidrawSnapshot {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  boardId   String   @db.ObjectId
  name      String
  elements  Json
  appState  Json
  files     Json     @default("{}")
  createdBy String
  createdById String? @db.ObjectId
  createdAt DateTime @default(now())
}

model Order {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  client      String   // Phone number in format xxx-xxxx
  clientName  String   // Client name
  description String
  service     String   // Service type
  startDate   String?  // Optional - Stored as YYYY-MM-DD
  endDate     String?  // Optional - Stored as YYYY-MM-DD
  employee    String   // Legacy: keep for backward compatibility
  totalPrice  Float
  employeePaidAmount Float @default(0) // Track amount paid to employee
  notes       String?
  createdBy   String   // Legacy: keep for backward compatibility
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // New: User ID tracking
  employeeId  String?  @db.ObjectId
  createdById String?  @db.ObjectId
  
  // Relations
  employeeUser  User?  @relation("OrderEmployee", fields: [employeeId], references: [id])
  createdByUser User?  @relation("OrderCreator", fields: [createdById], references: [id])
  isPaid        Boolean  @default(false)
  payments      Payment[]
  employeePayments EmployeePayment[]
  notifications Notification[]
  
  // Indexes for query performance
  @@index([createdAt])
  @@index([employeeId])
}

model Payment {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId       String   @db.ObjectId
  amount        Float
  paymentDate   DateTime
  paymentMethod String   // CASH, CARD, BANK_TRANSFER
  receivedBy    String   // Legacy: keep for backward compatibility
  receiptNumber String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // New: User ID tracking (accepts CUID from NextAuth)
  receivedById  String?
  
  // Relations
  order          Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  receivedByUser User?  @relation("PaymentReceiver", fields: [receivedById], references: [id])
  
  // Indexes for query performance
  @@index([paymentDate])
  @@index([orderId])
  @@index([receivedById])
}

model EmployeePayment {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId       String   @db.ObjectId
  amount        Float
  paymentDate   DateTime
  paymentMethod String   // CASH, CARD, BANK_TRANSFER
  processedBy   String   
  recipient     String?  // Who actually received the money (if different from order employee)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // User ID tracking
  processedById String?  @db.ObjectId
  
  // Relations
  order          Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  processedByUser User?  @relation("EmployeePaymentProcessor", fields: [processedById], references: [id])
  
  // Indexes for query performance
  @@index([paymentDate])
  @@index([orderId])
  @@index([processedById])
}

model Transaction {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  type        String   // INCOME or EXPENSE
  amount      Float
  description String
  category    String?  // Optional: Salary, Bills, Other Income, etc.
  date        DateTime
  createdBy   String   // Legacy: keep for backward compatibility
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // New: User ID tracking
  createdById String?  @db.ObjectId
  
  // Optional: Link to order for invoice payment transactions
  orderId           String?  @db.ObjectId
  
  // Optional: Link to employee payment for salary transactions
  employeePaymentId String?  @db.ObjectId
  
  // Relation
  createdByUser User?  @relation("TransactionCreator", fields: [createdById], references: [id])
  
  // Indexes for query performance
  @@index([date])
  @@index([type])
  @@index([createdById])
  @@index([orderId])
  @@index([employeePaymentId])
}

model Note {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  content     String
  color       String    @default("#fef3c7")
  
  // Position & Size on canvas
  posX        Float     @default(100)
  posY        Float     @default(100)
  width       Float     @default(250)
  height      Float     @default(200)
  
  // Organization
  isPinned    Boolean   @default(false)
  isArchived  Boolean   @default(false)
  categoryId  String?   @db.ObjectId
  category    NoteCategory? @relation(fields: [categoryId], references: [id])
  
  // Reminder
  reminderDate DateTime?
  
  // Ownership
  userId      String    @db.ObjectId
  user        User      @relation(fields: [userId], references: [id])
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([userId])
  @@index([isArchived])
}

model NoteCategory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  color     String   @default("#6b7280")
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  notes     Note[]
  createdAt DateTime @default(now())
  
  @@index([userId])
}
